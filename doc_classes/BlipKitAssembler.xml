<?xml version="1.0" encoding="UTF-8" ?>
<class name="BlipKitAssembler" inherits="RefCounted" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/godotengine/godot/master/doc/class.xsd">
	<brief_description>
		Generates byte code from instructions.
	</brief_description>
	<description>
		Generates byte code from instructions which can be executed with [BlipKitInterpreter].
		Named labels can be used to create function calls and loops.
		[b]Example:[/b] Add instructions to play an iconic startup sound:
		[codeblocks]
		[gdscript]
		var assem := BlipKitAssembler.new()

		# Initialize track.
		assem.put(BlipKitAssembler.OP_WAVEFORM, BlipKitTrack.WAVEFORM_SQUARE)
		assem.put(BlipKitAssembler.OP_DUTY_CYCLE, 8)

		# Define a label "start" to loop back.
		assem.put_label("start")

		# Play notes.
		assem.put(BlipKitAssembler.OP_ATTACK, BlipKitTrack.NOTE_C_5)
		assem.put(BlipKitAssembler.OP_STEP, 1)
		assem.put(BlipKitAssembler.OP_ATTACK, BlipKitTrack.NOTE_C_6)
		assem.put(BlipKitAssembler.OP_VOLUME_SLIDE, 9)
		assem.put(BlipKitAssembler.OP_VOLUME, 0.0)
		assem.put(BlipKitAssembler.OP_STEP, 9)
		assem.put(BlipKitAssembler.OP_RELEASE)
		assem.put(BlipKitAssembler.OP_VOLUME_SLIDE, 0)
		assem.put(BlipKitAssembler.OP_VOLUME, 1.0)
		assem.put(BlipKitAssembler.OP_STEP, 10)

		# Jump back to label "start".
		assem.put(BlipKitAssembler.OP_JUMP, "start")

		# Compile byte code and check for errors.
		if assem.compile() != BlipKitAssembler.OK:
		    printerr(assem.get_error_message())
		    return

		# Get the byte code.
		var bytes := assem.get_byte_code()
		[/gdscript]
		[/codeblocks]
	</description>
	<tutorials>
	</tutorials>
	<methods>
		<method name="clear">
			<return type="void" />
			<description>
				Clears all instructions, labels and errors.
			</description>
		</method>
		<method name="compile">
			<return type="int" enum="BlipKitAssembler.Error" />
			<description>
				Resolves label addresses and generates the byte code.
				Call [method get_byte_code] to get the byte code. Call [method clear] to generate new byte code.
				Returns [constant ERR_INVALID_STATE] if the byte code is already compiled.
			</description>
		</method>
		<method name="get_byte_code">
			<return type="BlipKitBytecode" />
			<description>
				Returns the generated byte code.
				Returns an empty array if [method compile] was not called yet, or an error occurred.
			</description>
		</method>
		<method name="get_error_message" qualifiers="const">
			<return type="String" />
			<description>
				Returns the last error as string.
				Returns an empty string if no error occurred.
			</description>
		</method>
		<method name="put">
			<return type="int" enum="BlipKitAssembler.Error" />
			<param index="0" name="opcode" type="int" enum="BlipKitAssembler.Opcode" />
			<param index="1" name="arg1" type="Variant" default="null" />
			<param index="2" name="arg2" type="Variant" default="null" />
			<param index="3" name="arg3" type="Variant" default="null" />
			<description>
				Adds an instruction and returns [constant OK] on success. See [enum Opcode] for the required arguments.
				Returns [constant ERR_INVALID_OPCODE] if [param opcode] is not valid.
				Returns [constant ERR_INVALID_ARGUMENT] if the arguments are invalid for [param opcode].
				Returns [constant ERR_INVALID_STATE] if the byte code is already compiled.
			</description>
		</method>
		<method name="put_byte_code">
			<return type="int" enum="BlipKitAssembler.Error" />
			<param index="0" name="byte_code" type="BlipKitBytecode" />
			<param index="1" name="public" type="bool" default="false" />
			<description>
				Adds compiled [BlipKitBytecode] and returns [constant OK] on success. Public labels from [param byte_code] are added to the existing labels.
				If [param public] is [code]true[/code], public labels from [param byte_code] are also made public.
				Returns [constant ERR_DUPLICATE_LABEL] if a label in [param byte_code] already exists.
				Returns [constant ERR_INVALID_ARGUMENT] if [param byte_code] is not valid.
				Returns [constant ERR_INVALID_STATE] if the byte code is already compiled.
			</description>
		</method>
		<method name="put_label">
			<return type="int" enum="BlipKitAssembler.Error" />
			<param index="0" name="label" type="String" />
			<param index="1" name="public" type="bool" default="false" />
			<description>
				Adds a named label at the current position which can be referenced by [constant OP_CALL] and [constant OP_JUMP] instructions.
				If [param public] is [code]true[/code], the label can be used as entry point when loading byte code with [method BlipKitInterpreter.load_byte_code].
				Returns [constant ERR_DUPLICATE_LABEL] if a label with the same name is already defined.
				Returns [constant ERR_INVALID_STATE] if the byte code is already compiled.
				[b]Note:[/b] The name is limited to [code]255[/code] bytes. If the name is longer when converted to UTF-8, [constant ERR_INVALID_LABEL] is returned.
			</description>
		</method>
	</methods>
	<constants>
		<constant name="OP_ATTACK" value="2" enum="Opcode">
			Sets [member BlipKitTrack.note]. Expects a [float] argument.
		</constant>
		<constant name="OP_RELEASE" value="3" enum="Opcode">
			Calls [method BlipKitTrack.release]. Expects no arguments.
		</constant>
		<constant name="OP_MUTE" value="4" enum="Opcode">
			Calls [method BlipKitTrack.mute]. Expects no arguments.
		</constant>
		<constant name="OP_VOLUME" value="5" enum="Opcode">
			Sets [member BlipKitTrack.volume]. Expects a [float] argument between [code]0.0[/code] and [code]1.0[/code].
		</constant>
		<constant name="OP_MASTER_VOLUME" value="6" enum="Opcode">
			Sets [member BlipKitTrack.master_volume]. Expects a [float] argument between [code]0.0[/code] and [code]1.0[/code].
		</constant>
		<constant name="OP_PANNING" value="7" enum="Opcode">
			Sets [member BlipKitTrack.panning]. Expects a [float] argument between [code]-1.0[/code] and [code]+1.0[/code].
		</constant>
		<constant name="OP_WAVEFORM" value="8" enum="Opcode">
			Sets [member BlipKitTrack.waveform]. Expects [enum BlipKitTrack.Waveform] as [int] argument.
		</constant>
		<constant name="OP_DUTY_CYCLE" value="9" enum="Opcode">
			Sets [member BlipKitTrack.duty_cycle]. Expects an [int] argument between [code]0[/code] and [code]15[/code].
		</constant>
		<constant name="OP_PITCH" value="10" enum="Opcode">
			Sets [member BlipKitTrack.pitch]. Expects a [float] argument.
		</constant>
		<constant name="OP_PHASE_WRAP" value="11" enum="Opcode">
			Sets [member BlipKitTrack.phase_wrap]. Expects an [int] argument.
		</constant>
		<constant name="OP_PORTAMENTO" value="12" enum="Opcode">
			Sets [member BlipKitTrack.portamento]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_VIBRATO" value="13" enum="Opcode">
			Calls [method BlipKitTrack.set_vibrato]. Expects [code]ticks[/code] ([int] between [code]0[/code] and [code]65536[/code]), [code]delta[/code] ([float]) and [code]slide_ticks[/code] ([int] between [code]0[/code] and [code]65536[/code]).
		</constant>
		<constant name="OP_TREMOLO" value="14" enum="Opcode">
			Calls [method BlipKitTrack.set_tremolo]. Expects [code]ticks[/code] ([int] between [code]0[/code] and [code]65536[/code]), [code]delta[/code] ([float]) and [code]slide_ticks[/code] ([int] between [code]0[/code] and [code]65536[/code]).
		</constant>
		<constant name="OP_VOLUME_SLIDE" value="15" enum="Opcode">
			Sets [member BlipKitTrack.volume_slide]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_PANNING_SLIDE" value="16" enum="Opcode">
			Sets [member BlipKitTrack.panning_slide]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_EFFECT_DIV" value="17" enum="Opcode">
			Sets [member BlipKitTrack.effect_divider]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_ARPEGGIO" value="18" enum="Opcode">
			Sets [member BlipKitTrack.arpeggio]. Expects a [PackedFloat32Array] argument.
		</constant>
		<constant name="OP_ARPEGGIO_DIV" value="19" enum="Opcode">
			Sets [member BlipKitTrack.arpeggio_divider]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_TICK" value="20" enum="Opcode">
			Interrupts the execution for a number of [i]ticks[/i]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_STEP" value="21" enum="Opcode">
			Interrupts the execution for a number of [i]ticks[/i] multiplied with [member BlipKitInterpreter.step_ticks]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_STEP_TICKS" value="22" enum="Opcode">
			Sets [member BlipKitInterpreter.step_ticks]. Expects an [int] argument between [code]1[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_DELAY_TICK" value="23" enum="Opcode">
			Delays the execution of the following instructions by the given number of [i]ticks[/i]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
			Must be followed by a [constant OP_STEP] or [constant OP_TICK] instruction eventually. A maximum of [code]8[/code] delay [constant OP_DELAY_TICK] or [constant OP_DELAY_STEP] instruction sequences can be chained together.
			[b]Note:[/b] This instruction does not interrupt the execution.
		</constant>
		<constant name="OP_DELAY_STEP" value="24" enum="Opcode">
			Delays the execution of the following instructions by the given number of [i]steps[/i] (can be a fraction). Expects a [float] argument between [code]0.0[/code] and [code]65536.0[/code].
			Must be followed by a [constant OP_STEP] or [constant OP_TICK] instruction eventually. A maximum of [code]8[/code] delay [constant OP_DELAY_TICK] or [constant OP_DELAY_STEP] instruction sequences can be chained together.
			[b]Note:[/b] This instruction does not interrupt the execution.
		</constant>
		<constant name="OP_JUMP" value="25" enum="Opcode">
			Jumps to a named label. Expects the label name as [String] argument.
			[b]Note:[/b] The label is not required to be defined at this point and can also be set later with [method put_label].
		</constant>
		<constant name="OP_CALL" value="26" enum="Opcode">
			Calls a named label like a function. Expects a label name as [String] argument.
			[b]Note:[/b] The label is not required to be defined at this point and can also be set later with [method put_label].
		</constant>
		<constant name="OP_RETURN" value="27" enum="Opcode">
			Returns from a function call made with [constant OP_CALL]. Expects no arguments.
		</constant>
		<constant name="OP_RESET" value="28" enum="Opcode">
			Calls [method BlipKitTrack.reset]. Expects no arguments.
		</constant>
		<constant name="OP_INSTRUMENT" value="29" enum="Opcode">
			Sets [member BlipKitTrack.instrument] from the given slot. Expects a slot index between [code]0[/code] and [code]255[/code] as [int] argument.
			Which [BlipKitInstrument] is used is defined with [method BlipKitInterpreter.set_instrument].
			[b]Note:[/b] An instrument cannot be unset. Keep a slot empty to be able to set an empty instrument (for example, [code]255[/code]) if needed.
		</constant>
		<constant name="OP_INSTRUMENT_DIV" value="30" enum="Opcode">
			Sets [member BlipKitTrack.instrument_divider]. Expects an [int] argument between [code]0[/code] and [code]65536[/code].
		</constant>
		<constant name="OP_CUSTOM_WAVEFORM" value="31" enum="Opcode">
			Sets [member BlipKitTrack.custom_waveform] from the given slot. Expects a slot index as [int] argument between [code]0[/code] and [code]255[/code].
			Which [BlipKitWaveform] is used is defined with [method BlipKitInterpreter.set_waveform].
			[b]Note:[/b] If the custom waveform is set to an empty slot, the waveform is reset to [constant BlipKitTrack.WAVEFORM_SQUARE].
		</constant>
		<constant name="OP_SAMPLE" value="32" enum="Opcode">
			Sets [member BlipKitTrack.sample] from the given slot. Expects a slot index between [code]0[/code] and [code]255[/code] as [int] argument.
			Which [BlipKitSample] is used is defined with [method BlipKitInterpreter.set_sample].
			[b]Note:[/b] If the sample is set to an empty slot, the waveform is reset to [constant BlipKitTrack.WAVEFORM_SQUARE].
		</constant>
		<constant name="OP_SAMPLE_PITCH" value="33" enum="Opcode">
			Sets [member BlipKitTrack.sample_pitch]. Expects a [float] argument.
		</constant>
		<constant name="OK" value="0" enum="Error">
			No error.
		</constant>
		<constant name="ERR_INVALID_STATE" value="1" enum="Error">
			The assembler is not in the correct state.
		</constant>
		<constant name="ERR_INVALID_OPCODE" value="2" enum="Error">
			The instruction is invalid.
		</constant>
		<constant name="ERR_INVALID_ARGUMENT" value="3" enum="Error">
			An instruction argument is invalid.
		</constant>
		<constant name="ERR_DUPLICATE_LABEL" value="4" enum="Error">
			The label already exists with the same name.
		</constant>
		<constant name="ERR_UNDEFINED_LABEL" value="5" enum="Error">
			A label is not defined with the given name.
		</constant>
		<constant name="ERR_INVALID_LABEL" value="6" enum="Error">
			The label has an invalid name.
		</constant>
	</constants>
</class>
